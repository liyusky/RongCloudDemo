<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>聊天</title>
  <link rel="stylesheet" href="./css/resetting.css">
  <link rel="stylesheet" href="./css/conversation.css">
  <link rel="stylesheet" href="./css/list.css">
  <link rel="stylesheet" href="./css/minimize.css">
  <link rel="stylesheet" href="./css/nav.css">
  <link rel="stylesheet" href="./css/teleprompter.css">
  <link rel="stylesheet" href="./css/redirect.css">
  <link rel="stylesheet" href="./css/live.css">
  <link rel="stylesheet" href="./css/sundry.css">
  <link rel="stylesheet" href="./font/iconfont.css">
  <script src="./javascript/require.js" charset="utf-8"></script>
  <script src="./javascript/jquery.min.js" charset="utf-8"></script>
  <script src="./javascript/RongIMLib-2.2.5.min.js" charset="utf-8"></script>
</head>

<body>
  <div id="webchat" class="webchat fixed">
    <!-- s 导航栏 -->
    <nav class="webchat-nav fl relative" id="webchat-nav">
      <ul class="webchat-nav-list">
        <li class="webchat-nav-tag" title="头像">
          <div class="webchat-nav-avatar" id="webchat-nav-avatar">剑</div>
        </li>
        <li class="webchat-nav-tag relative  chating-sign" data-type="customer" onclick="javascript: WebChat.showList('customer');" title="客户">
          <i class="iconfont icon-102 webchat-nav-icon"></i>
        </li>
        <li class="webchat-nav-tag relative" data-type="waiter" onclick="javascript: WebChat.showList('waiter');" title="客服">
          <i class="iconfont icon-kefu webchat-nav-icon"></i>
        </li>
        <li class="webchat-nav-tag relative" data-type="black" onclick="javascript: WebChat.showList('black');" title="黑名单">
          <i class="iconfont icon-heimingdan webchat-nav-icon"></i>
        </li>
      </ul>
      <div class="webchat-nav-retract" title="收起">
        <i class="iconfont icon-shouqi2 webchat-nav-icon" onclick="javascript: WebChat.minimize();"></i>
      </div>
    </nav>
    <!-- e 导航栏 -->

    <!-- s 会话列表 -->
    <section class="webchat-list fl" id="webchat-list">
      <div class="webchat-list-action">
        <div class="webchat-input-box fl">
          <input type="text" class="list-input fl" id="webchat-seach-input">
        </div>
        <div class="list-action-nav fl">
          <i class="iconfont icon-search list-action-btn" title="搜索" onclick="javascript: WebChat.seachTip();"></i>
        </div>
      </div>
      <div class="webchat-list-wrap relative">
        <ul class="webchat-list-content" id="webchat-list-customer"></ul>
        <ul class="webchat-list-content hidden" id="webchat-list-waiter"></ul>
        <ul class="webchat-list-content hidden" id="webchat-list-black"></ul>
        <ul class="webchat-list-content hidden" id="webchat-list-seach"></ul>
      </div>
    </section>
    <!-- e 会话列表 -->

    <!-- s 会话内容 -->
    <section class="webchat-conversation fl" id="webchat-conversation">
      <div class="webchat-conversation-header relative" id="webchat-conversation-header">
        <div class="webchat-customer-title">
          <span id="webchat-customer-name" class="relative">liyusky</span>
          <i class="iconfont icon-jiantou-copy" onclick="javascript: WebChat.loadHistoryMsg('history');"></i>
        </div>
        <div class="webchat-conversation-tools tools-right" id="webchat-conversation-tools-right">
          <i class="iconfont icon-jishiben tools-btn" onclick="javascript: WebChat.showTeleprompter();"></i>
          <i class="iconfont icon-zuixiaohua tools-btn" onclick="javascript: WebChat.minimize();"></i>
          <i class="iconfont icon-shanchu4 tools-btn radius-t-r-5" style="font-size: 14px;" onclick="javascript: WebChat.closeWebChat();"></i>
        </div>
        <div class="webchat-conversation-tools tools-left">
          <i class="iconfont icon-jiantou-copy-copy tools-btn" onclick="javascript: WebChat.hideWindow();"></i>
        </div>
      </div>
      <div class="webchat-conversation-window" id="webchat-conversation-window">
        <ul class="webchat-conversation-content" id="webchat-conversation-content"></ul>
      </div>
      <div class="webchat-conversation-write" id="webchat-conversation-write">
        <textarea class="webchat-input fl" id="webchat-input"></textarea>
        <div class="webchat-image-nav fl">
          <ul class="webchat-image-list" id="webchat-image-list"></ul>
        </div>
        <button type="button" class="webchat-send-btn fr" onclick="javascript: WebChat.send();">发送</button>
      </div>
    </section>
    <!-- e 会话内容 -->

    <!-- s 提词器 -->
    <section class="webchat-teleprompter fl radius-t-r-5 radius-b-r-5" id="webchat-teleprompter">
      <div class="webchat-teleprompter-header radius-t-r-5">
        <i class="iconfont icon-jiantou-copy-copy fl" onclick="javascript: WebChat.closeTeleprompter();"></i>
        <span>快捷发送</span>
        <i class="iconfont icon-icon fr" onclick="javascript: WebChat.addTeleprompter();"></i>
      </div>
      <ul class="webchat-teleprompter-content radius-b-r-5" data-count="3" id="webchat-teleprompter-content">
        <li class="webchat-teleprompter-item">
          <div class="teleprompter-item-header" data-link-content="teleprompter-default">
            <i class="iconfont icon-spreadup teleprompter-expansion-sign fl" onclick="javascript: WebChat.showLinkContent($(this));" data-show="1"></i>
            <p class="webchat-teleprompter-title omit fl" ondblclick="javascript: WebChat.modifyTitle($(this));">默认提词器</p>
            <i class="iconfont icon-tianjia teleprompter-expansion-sign fr" onclick="javascript: WebChat.addLinkHint($(this));"></i>
            <i class="iconfont icon-shanchu3 teleprompter-expansion-sign fr" onclick="javascript: WebChat.removeLinkContent($(this));"></i>
          </div>
          <ul class="teleprompter-item-content" id="teleprompter-default">
            <li class="teleprompter-hint hint-default-height">
              <i class="iconfont icon-zhankai teleprompter-hint-operation fl" onclick="javascript: WebChat.showWholeHint($(this));"></i>
              <i class="iconfont icon-xiugai teleprompter-hint-operation fl" onclick="javascript: WebChat.modifyHint($(this));"></i>
              <i class="iconfont icon-shanchu2 teleprompter-hint-operation fl" onclick="javascript: WebChat.deleteHint($(this));"></i>
              <p class="teleprompter-hint-message omit no-select" ondblclick="javascript: WebChat.quickSend($(this));">第一条</p>
            </li>
            <li class="teleprompter-hint hint-default-height">
              <img src="" class="teleprompter-hint-operation fl" onclick="javascript: WebChat.showWholeHint($(this));">
              <img src="" class="teleprompter-hint-operation fl" onclick="javascript: WebChat.modifyHint($(this));">
              <img src="" class="teleprompter-hint-operation fl" onclick="javascript: WebChat.deleteHint($(this));">
              <p class="teleprompter-hint-message omit no-select" ondblclick="javascript: WebChat.quickSend($(this));">第二条</p>
            </li>
            <li class="teleprompter-hint hint-default-height">
              <img src="" class="teleprompter-hint-operation fl" onclick="javascript: WebChat.showWholeHint($(this));">
              <img src="" class="teleprompter-hint-operation fl" onclick="javascript: WebChat.modifyHint($(this));">
              <img src="" class="teleprompter-hint-operation fl" onclick="javascript: WebChat.deleteHint($(this));">
              <p class="teleprompter-hint-message omit no-select" ondblclick="javascript: WebChat.quickSend($(this));">第三条</p>
            </li>
            <li class="teleprompter-hint hint-default-height">
              <img src="" class="teleprompter-hint-operation fl" onclick="javascript: WebChat.showWholeHint($(this));">
              <img src="" class="teleprompter-hint-operation fl" onclick="javascript: WebChat.modifyHint($(this));">
              <img src="" class="teleprompter-hint-operation fl" onclick="javascript: WebChat.deleteHint($(this));">
              <p class="teleprompter-hint-message omit no-select" ondblclick="javascript: WebChat.quickSend($(this));">第四条</p>
            </li>
            <li class="teleprompter-hint hint-default-height">
              <img src="" class="teleprompter-hint-operation fl" onclick="javascript: WebChat.showWholeHint($(this));">
              <img src="" class="teleprompter-hint-operation fl" onclick="javascript: WebChat.modifyHint($(this));">
              <img src="" class="teleprompter-hint-operation fl" onclick="javascript: WebChat.deleteHint($(this));">
              <p class="teleprompter-hint-message omit no-select" ondblclick="javascript: WebChat.quickSend($(this));">第五条</p>
            </li>
            <li class="teleprompter-hint hint-default-height">
              <img src="" class="teleprompter-hint-operation fl" onclick="javascript: WebChat.showWholeHint($(this));">
              <img src="" class="teleprompter-hint-operation fl" onclick="javascript: WebChat.modifyHint($(this));">
              <img src="" class="teleprompter-hint-operation fl" onclick="javascript: WebChat.deleteHint($(this));">
              <p class="teleprompter-hint-message omit no-select" ondblclick="javascript: WebChat.quickSend($(this));">第六条</p>
            </li>
            <li class="teleprompter-hint hint-default-height">
              <img src="" class="teleprompter-hint-operation fl" onclick="javascript: WebChat.showWholeHint($(this));">
              <img src="" class="teleprompter-hint-operation fl" onclick="javascript: WebChat.modifyHint($(this));">
              <img src="" class="teleprompter-hint-operation fl" onclick="javascript: WebChat.deleteHint($(this));">
              <p class="teleprompter-hint-message omit no-select" ondblclick="javascript: WebChat.quickSend($(this));">第七条</p>
            </li>
          </ul>
        </li>
        <li class="webchat-teleprompter-item">
          <div class="teleprompter-item-header" data-link-content="teleprompter-1">
            <img src="" class="teleprompter-expansion-sign fl">
            <p class="webchat-teleprompter-title omit fl">xdfasfad</p>
            <img src="" class="teleprompter-expansion-sign fr">
          </div>
          <ul class="teleprompter-item-content" id="teleprompter-1">
            <li class="teleprompter-hint hint-default-height">
              <img src="" class="teleprompter-hint-operation fl" onclick="javascript: WebChat.showWholeHint($(this));">
              <img src="" class="teleprompter-hint-operation fl" onclick="javascript: WebChat.modifyHint($(this));">
              <img src="" class="teleprompter-hint-operation fl" onclick="javascript: WebChat.deleteHint($(this));">
              <p class="teleprompter-hint-message omit no-select" ondblclick="javascript: WebChat.quickSend($(this));">xxxxxxxxxxxhdfghdfghfdghfghfxxxxxxxxxxxxxxxxx</p>
            </li>
            <li class="teleprompter-hint hint-default-height">
              <img src="" class="teleprompter-hint-operation fl" onclick="javascript: WebChat.showWholeHint($(this));">
              <img src="" class="teleprompter-hint-operation fl" onclick="javascript: WebChat.modifyHint($(this));">
              <img src="" class="teleprompter-hint-operation fl" onclick="javascript: WebChat.deleteHint($(this));">
              <p class="teleprompter-hint-message omit no-select" ondblclick="javascript: WebChat.quickSend($(this));">xxxxxxxxxxxhdfghdfghfdghfghfxxxxxxxxxxxxxxxxx</p>
            </li>
            <li class="teleprompter-hint hint-default-height">
              <img src="" class="teleprompter-hint-operation fl" onclick="javascript: WebChat.showWholeHint($(this));">
              <img src="" class="teleprompter-hint-operation fl" onclick="javascript: WebChat.modifyHint($(this));">
              <img src="" class="teleprompter-hint-operation fl" onclick="javascript: WebChat.deleteHint($(this));">
              <p class="teleprompter-hint-message omit no-select" ondblclick="javascript: WebChat.quickSend($(this));">xxxxxxxxxxxhdfghdfghfdghfghfxxxxxxxxxxxxxxxxx</p>
            </li>
            <li class="teleprompter-hint hint-default-height">
              <img src="" class="teleprompter-hint-operation fl" onclick="javascript: WebChat.showWholeHint($(this));">
              <img src="" class="teleprompter-hint-operation fl" onclick="javascript: WebChat.modifyHint($(this));">
              <img src="" class="teleprompter-hint-operation fl" onclick="javascript: WebChat.deleteHint($(this));">
              <p class="teleprompter-hint-message omit no-select" ondblclick="javascript: WebChat.quickSend($(this));">xxxxxxxxxxxhdfghdfghfdghfghfxxxxxxxxxxxxxxxxx</p>
            </li>
            <li class="teleprompter-hint hint-default-height">
              <img src="" class="teleprompter-hint-operation fl" onclick="javascript: WebChat.showWholeHint($(this));">
              <img src="" class="teleprompter-hint-operation fl" onclick="javascript: WebChat.modifyHint($(this));">
              <img src="" class="teleprompter-hint-operation fl" onclick="javascript: WebChat.deleteHint($(this));">
              <p class="teleprompter-hint-message omit no-select" ondblclick="javascript: WebChat.quickSend($(this));">xxxxxxxxxxxhdfghdfghfdghfghfxxxxxxxxxxxxxxxxx</p>
            </li>
            <li class="teleprompter-hint hint-default-height">
              <img src="" class="teleprompter-hint-operation fl" onclick="javascript: WebChat.showWholeHint($(this));">
              <img src="" class="teleprompter-hint-operation fl" onclick="javascript: WebChat.modifyHint($(this));">
              <img src="" class="teleprompter-hint-operation fl" onclick="javascript: WebChat.deleteHint($(this));">
              <p class="teleprompter-hint-message omit no-select" ondblclick="javascript: WebChat.quickSend($(this));">xxxxxxxxxxxhdfghdfghfdghfghfxxxxxxxxxxxxxxxxx</p>
            </li>
            <li class="teleprompter-hint hint-default-height">
              <img src="" class="teleprompter-hint-operation fl" onclick="javascript: WebChat.showWholeHint($(this));">
              <img src="" class="teleprompter-hint-operation fl" onclick="javascript: WebChat.modifyHint($(this));">
              <img src="" class="teleprompter-hint-operation fl" onclick="javascript: WebChat.deleteHint($(this));">
              <p class="teleprompter-hint-message omit no-select" ondblclick="javascript: WebChat.quickSend($(this));">xxxxxxxxxxxhdfghdfghfdghfghfxxxxxxxxxxxxxxxxx</p>
            </li>
          </ul>
        </li>
        <li class="webchat-teleprompter-item">
          <div class="teleprompter-item-header" data-link-content="teleprompter-2">
            <img src="" class="teleprompter-expansion-sign fl">
            <p class="webchat-teleprompter-title omit fl">xdfasfad</p>
            <img src="" class="teleprompter-expansion-sign fr">
          </div>
          <ul class="teleprompter-item-content" id="teleprompter-2">
            <li class="teleprompter-hint hint-default-height">
              <img src="" class="teleprompter-hint-operation fl" onclick="javascript: WebChat.showWholeHint($(this));">
              <img src="" class="teleprompter-hint-operation fl" onclick="javascript: WebChat.modifyHint($(this));">
              <img src="" class="teleprompter-hint-operation fl" onclick="javascript: WebChat.deleteHint($(this));">
              <p class="teleprompter-hint-message omit no-select" ondblclick="javascript: WebChat.quickSend($(this));">xxxxxxxxxxxhdfghdfghfdghfghfxxxxxxxxxxxxxxxxx</p>
            </li>
            <li class="teleprompter-hint hint-default-height">
              <img src="" class="teleprompter-hint-operation fl" onclick="javascript: WebChat.showWholeHint($(this));">
              <img src="" class="teleprompter-hint-operation fl" onclick="javascript: WebChat.modifyHint($(this));">
              <img src="" class="teleprompter-hint-operation fl" onclick="javascript: WebChat.deleteHint($(this));">
              <p class="teleprompter-hint-message omit no-select" ondblclick="javascript: WebChat.quickSend($(this));">xxxxxxxxxxxhdfghdfghfdghfghfxxxxxxxxxxxxxxxxx</p>
            </li>
            <li class="teleprompter-hint hint-default-height">
              <img src="" class="teleprompter-hint-operation fl" onclick="javascript: WebChat.showWholeHint($(this));">
              <img src="" class="teleprompter-hint-operation fl" onclick="javascript: WebChat.modifyHint($(this));">
              <img src="" class="teleprompter-hint-operation fl" onclick="javascript: WebChat.deleteHint($(this));">
              <p class="teleprompter-hint-message omit no-select" ondblclick="javascript: WebChat.quickSend($(this));">xxxxxxxxxxxhdfghdfghfdghfghfxxxxxxxxxxxxxxxxx</p>
            </li>
            <li class="teleprompter-hint hint-default-height">
              <img src="" class="teleprompter-hint-operation fl" onclick="javascript: WebChat.showWholeHint($(this));">
              <img src="" class="teleprompter-hint-operation fl" onclick="javascript: WebChat.modifyHint($(this));">
              <img src="" class="teleprompter-hint-operation fl" onclick="javascript: WebChat.deleteHint($(this));">
              <p class="teleprompter-hint-message omit no-select" ondblclick="javascript: WebChat.quickSend($(this));">xxxxxxxxxxxhdfghdfghfdghfghfxxxxxxxxxxxxxxxxx</p>
            </li>
            <li class="teleprompter-hint hint-default-height">
              <img src="" class="teleprompter-hint-operation fl" onclick="javascript: WebChat.showWholeHint($(this));">
              <img src="" class="teleprompter-hint-operation fl" onclick="javascript: WebChat.modifyHint($(this));">
              <img src="" class="teleprompter-hint-operation fl" onclick="javascript: WebChat.deleteHint($(this));">
              <p class="teleprompter-hint-message omit no-select" ondblclick="javascript: WebChat.quickSend($(this));">xxxxxxxxxxxhdfghdfghfdghfghfxxxxxxxxxxxxxxxxx</p>
            </li>
            <li class="teleprompter-hint hint-default-height">
              <img src="" class="teleprompter-hint-operation fl" onclick="javascript: WebChat.showWholeHint($(this));">
              <img src="" class="teleprompter-hint-operation fl" onclick="javascript: WebChat.modifyHint($(this));">
              <img src="" class="teleprompter-hint-operation fl" onclick="javascript: WebChat.deleteHint($(this));">
              <p class="teleprompter-hint-message omit no-select" ondblclick="javascript: WebChat.quickSend($(this));">xxxxxxxxxxxhdfghdfghfdghfghfxxxxxxxxxxxxxxxxx</p>
            </li>
            <li class="teleprompter-hint hint-default-height">
              <img src="" class="teleprompter-hint-operation fl" onclick="javascript: WebChat.showWholeHint($(this));">
              <img src="" class="teleprompter-hint-operation fl" onclick="javascript: WebChat.modifyHint($(this));">
              <img src="" class="teleprompter-hint-operation fl" onclick="javascript: WebChat.deleteHint($(this));">
              <p class="teleprompter-hint-message omit no-select" ondblclick="javascript: WebChat.quickSend($(this));">xxxxxxxxxxxhdfghdfghfdghfghfxxxxxxxxxxxxxxxxx</p>
            </li>
          </ul>
        </li>
      </ul>
    </section>
    <!-- e 提词器 -->

    <!-- s 缩略栏 -->
    <section class="webchat-minimize" id="webchat-minimize">
      <i class="iconfont icon-zhankai1 minimize-sign webchat-open-sign fl" id="webchat-open-sign" onclick="javascript: WebChat.openWebChat();" title="展开"></i>
      <i class="iconfont icon-renshu minimize-sign fl" title="发来消息的人数"></i>
      <span class="minimize-count fl">5</span>
      <i class="iconfont icon-weiduxiaoxi minimize-sign fl" title="未读消息数"></i>
      <span class="minimize-count fl">100</span>
    </section>
    <!-- e 缩略栏 -->

    <!-- s modal -->
    <section class="webchat-modal fixed" id="webchat-modal">
      <div class="modal-img-box">
        <img class="webchat-exhibit" src="" id="webchat-exhibit">
      </div>
    </section>
    <!-- e modal -->

    <!-- s 客服转接列表 -->
    <section class="webchat-redirect hidden" id="webchat-redirect">
      <header class="webchat-redirect-header">选择您要转接的客服</header>
      <ul class="webchat-waiter-list" id="webchat-waiter-list"></ul>
      <footer class="redirect-btn-nav">
        <div class="redirect-btn fr" onclick="javascript: WebChat.closeRedirectWindow();">取消</div>
        <div class="redirect-btn fr" onclick="javascript: WebChat.redirecting($(this));">确认</div>
      </footer>
    </section>
    <!-- e 客服转接列表 -->

    <!-- s 杂项 -->
    <section class="webchat-sundry" id="webchat-sundry">
      <canvas class="webchat-back-canvas" id="webchat-back-canvas"></canvas>
      <img src="" class="webchat-back-photo" id="webchat-back-photo">
      <!-- <input type="file" id="webchat-file-input" multiple="true" onchange="javascript: WebChat.getImage();"> -->
    </section>
    <!-- e 杂项 -->

  </div>
  <script type="text/javascript">
    var WebChat = {
      Attrs: null,
      Doms: null,
      RongCloud: null,
      main: function () {
        this.detectEnvironment();
        this.initAttrs();
        this.getToken();
        this.initDoms();
        this.initList();
        this.initRedirect();
        this.loadRongCloud();
        this.initEvent();
      },

      /* s 初始化 */
        detectEnvironment: function () {
          if (typeof(Storage) == "undefined") {
            alert("您的浏览器未搭建本模块核心环境，请更换浏览器");
            return false;
          }
        },
        initAttrs: function () {
          this.RongCloud = {
            IMLib: null,
            IMClient: null,
            Token: null,
            AppKey: null
          };
          this.Attrs = {
            target: {
              id: null,        //当前交谈对象的id
              whole: {}       //所有有我交谈过的人
            },
            image: {
              files: [],      //抓取的图片的文件
              src: [],        //地址集合
              count: -1      //总共多少张
            },
            unreadCount:{},     //未读消息数
            current: {
              listType: "customer",    //当前的列表类型
              imageIndex: 0,
              tipType: "customer"
            },
            sendArgs: {      //发送的数据
              conversationtype: 1,
              msg: null
            },
            chatList: {      //交谈对象类型
              customer: {},
              waiter: {},
              black: {}
            },
            mark: {          //开关
              history: null
            },
          };
        },
        getToken: function () {
          // $.ajax({
          //     url: '/path/to/file',
          //     type: 'POST',
          //     async: false,
          //     dataType: 'JSON',
          //     data: {userId: userId},
          //     success: function(data) {
          //         this.AppKey = data.AppKey;
          //         this.Token = data.Token;
          //     }
          // });
          // this.Attrs.target.id = "1";
          this.RongCloud.AppKey = "qd46yzrfq0bzf";
          this.RongCloud.Token = "M7MX0gfSKd6L81+AI6lVXWu+MJ+TRSiRYDQiQyOR+6rolamrJDbsxz9SZKKJf79BLFidu2R9N1ODQinz4m10I6P5nqEpLAsD";
        },
        initDoms: function () {
          this.Doms = {
            webchatDom: $("#webchat"),      //whole wrap
            nav: {
              wholeDom: $("#webchat-nav"),
              avatarDom: $("#webchat-nav-avatar")
            },
            list:         {
              wholeDom:    $("#webchat-list"), //列表内容区
              inputDom:    $("#webchat-seach-input"),
              customerDom: $("#webchat-list-customer"),   //客户列表区
              waiterDom:   $("#webchat-list-waiter"),   //客服列表区
              blackDom:    $("#webchat-list-black"),   //黑名单列表区
              seachDom:    $("#webchat-list-seach")
            },
            conversation: {
              wholeDom:        $("#webchat-conversation"), //会话区
              headerDom:       $("#webchat-conversation-header"), //头部
              toolsRightDom:   $("#webchat-conversation-tools-right"),
              customerNameDom: $("#webchat-customer-name"), //客户名
              windowDom:       $("#webchat-conversation-window"), //会话窗口
              contentDom:      $("#webchat-conversation-content"), //会话内容部分
              writeDom:        $("#webchat-conversation-write"),    //输入区
              imageListDom:    $("#webchat-image-list"), //图片区
              inputDom:        $("#webchat-input"), //输入框
            },
            teleprompter: {
              wholeDom:   $("#webchat-teleprompter"),    //提词器
              contentDom: $("#webchat-teleprompter-content")    //提词器内容区
            },
            minimize:     {
              wholeDom:    $("#webchat-minimize"), //最小化按钮
              openSignDom: $("#webchat-open-sign")   //最小化打开标志
            },
            redirect:     {
              wholeDom:      $("#webchat-redirect"),
              waiterListDom: $("#webchat-waiter-list"),    //转接客服展示区
            },
            modal:        {
              wholeDom:   $("#webchat-modal"),      //modal
              exhibitDom: $("#webchat-exhibit"),      //展示的图片
            },
            sundry:       {
              // fileInputDom: $("#webchat-file-input"),      //FileUpload
              canvasDom:    $("#webchat-back-canvas"),    //画布
              backImageDom: $("#webchat-back-photo")
            },
            temporary:    {
              redirectTipDom: null,
              redirectWaiterDom: null,
              selectTipDom: null,
              navSignDom: $(".chating-sign")
            },
          };
        },
        initList: function () {
          if (localStorage.CustomerList) {
            this.Attrs.chatList.customer = JSON.parse(localStorage.CustomerList);
          }

          if (localStorage.WaiterList) {
            this.Attrs.chatList.waiter = JSON.parse(localStorage.WaiterList);
          }

          if (localStorage.BlackList) {
            this.Attrs.chatList.black = JSON.parse(localStorage.BlackList);
          }

          this.addListTip("customer");
          this.addListTip("waiter");
          this.addListTip("black");
        },
        initRedirect: function () {
          var WaiterList = this.Attrs.chatList.waiter;
          var htmlStr = "";
          for (var id in WaiterList) {
            var name = WaiterList[id];
            htmlStr += "<li class='waiter-list-item fl' data-id='" + id + "' onclick='javascript: WebChat.selectWaiter($(this));'>" +
              "<label>" +
              "<div class='webchat-waiter-message'>" +
              "<div class='webchat-waiter-avatar fl'>" + name.slice(-1)  + "</div>" +
              "<div class='webchat-waiter-name fr'>" + name + "</div>" +
              "</div>" +
              "</label>" +
              "</li>";
          }
          this.Doms.redirect.waiterListDom.append(htmlStr);
        },
        initEvent: function () {
          this.Doms.minimize.wholeDom.on("mousedown", this.movement);
          this.Doms.conversation.inputDom.on("keydown", this.inputOperate);
          this.Doms.modal.wholeDom.on("dblclick", this.hiddenModal);
          $(document).on("keydown", this.keepSide);
          this.Doms.conversation.writeDom[0].addEventListener("dragover", this.banCover);
          this.Doms.conversation.writeDom[0].addEventListener("drop", this.dropImg);
          document.addEventListener("dragover", this.banCover);
          document.addEventListener("drop", this.banCover);
        },
      /* e 初始化 */

      /* s 融云模块 */
        loadRongCloud: function() {      //加载融云模块
          require.config({ //导入文件
            paths: {
              protobuf: './javascript/protobuf-2.1.5.min',
              RongIMLib: './javascript/RongIMLib-2.2.5.min',
            }
          });
          require(['protobuf', 'RongIMLib'], function(protobuf, RongIMLib) { //加载导入的文件
            WebChat.RongCloud.IMClient = RongIMLib.RongIMClient;
            WebChat.initRongCloud();
            WebChat.setRongCloudListen();
            WebChat.connectRongCloudSever();
            // WebChat.getConversationList();
          });
        },
        initRongCloud: function() {      //初始化融云
          //初始化
          this.RongCloud.IMClient.init(this.RongCloud.AppKey);  //
          this.setMsgType("Redirection");
        },
        setRongCloudListen: function() {    //添加监听
          // 连接状态监听器
          this.RongCloud.IMClient.setConnectionStatusListener({
            onChanged: function(status) {
              switch (status) {
                case 0: //CONNECTED 链接成功
                  console.log("链接成功");
                  break;
                case 1: //CONNECTING 正在链接
                  console.log("正在链接");
                  break;
                case 2: //DISCONNECTED 断开连接
                  // WebChat.Warning("连接断开,请刷新重连");
                  console.log("断开连接");
                  break;
                case 3: //NETWORK_UNAVAILABLE 网络不可用
                  console.log("网络不可用");
                  // WebChat.Warning("网络不可用");
                  break;
                case 6: //KICKED_OFFLINE_BY_OTHER_CLIENT 其他设备登录
                  // WebChat.Warning("其他设备登录");
                  console.log("其他设备登录");
                  break;
              }
            }
          });
          // 消息监听器
          this.RongCloud.IMClient.setOnReceiveMessageListener({
            // 接收到的消息
            onReceived: function(message) {
              var targetId = message.senderUserId; //对方Id
              var extra = WebChat.translateJson(message.content.extra);    //获取额外信息
              var senderRole = extra.senderRole; //对方身份

              if (WebChat.Attrs.target.id === null) { //是第一个发送者
                WebChat.Attrs.target.id = targetId; //设置为当前聊天对象
              }

              if (!WebChat.Attrs.chatList.customer[targetId]) {   //没有记录该客户
                var name = extra.name;
                WebChat.Attrs.chatList.customer[targetId] = name;  //记录该客户
                localStorage.CustomerList = JSON.stringify(WebChat.Attrs.chatList.customer);
                WebChat.addListTip("customer", name, targetId); //添加该用户的tip
              }

              if (targetId === WebChat.Attrs.target.id) { //是当前聊天对象
                WebChat.Attrs.unreadCount[targetId] = 0; //该对象未读消息数清空
                WebChat.addSaying(message, "only"); //显示该消息
                WebChat.scrollToSide(WebChat.Doms.conversation.contentDom, WebChat.Doms.conversation.windowDom, "bottom");  //滚动靠边
              }
              else {
                WebChat.setUnreadStatus(targetId);
              }
            }
          });
        },
        connectRongCloudSever: function() {
          // 连接融云服务器。
          this.RongCloud.IMClient.connect(this.RongCloud.Token, {
            onSuccess: function(userId) {
              WebChat.getBlackList();
            },
            onTokenIncorrect: function() {},
            onError: function(errorCode) {
              console.log(errorCode);
              alert(JSON.stringify(errorCode));
            }
          });
        },
      /* e 融云模块 */

      /* s 消息*/
        send: function() { //发送消息
          var Attrs = this.Attrs;
          var textValue = this.Doms.conversation.inputDom.val(); //获取输入的内容
          var imageFiles = Attrs.image.files;
          var sendParam = null;

          if (!Attrs.target.id) {
            alert("请选择交谈对象");
            return false;
          }

          if (textValue) {
            sendParam = {
              type: "text",
              saying: textValue,
              extra: {
                senderRole: "waiter",
                receiveRole: Attrs.current.listType,
                name: "一二三",
                mobile: "12345678900",
              }
            };

            this.setSendArgs(sendParam);
            this.sendMessage(); //发送文本消息
          }

          if (imageFiles.length > 0) {
            WebChat.setThumbnail(this.singleImageSend);
          }

          this.Doms.conversation.inputDom.val(""); //清空输入框
        },
        singleImageSend: function(url) {
          sendParam = {
            type: "image",
            imgSrc: url,
            imgUri: "",
            extra: {
              senderRole: "waiter",
              receiveRole: WebChat.Attrs.current.listType,
              name: "一二三",
              mobile: "12345678900",
              unreadMessageCount: 0
            }
          };
          WebChat.setSendArgs(sendParam);
          var len = WebChat.Attrs.image.files.length;
          var index = WebChat.Attrs.current.imageIndex;
          if (index < len) {
            WebChat.sendMessage(function() {
              WebChat.Attrs.current.imageIndex += 1;
              var len = WebChat.Attrs.image.files.length;
              var index = WebChat.Attrs.current.imageIndex;
              if (index < len) {
                WebChat.setThumbnail(WebChat.singleImageSend);
              }
              else {
                WebChat.Attrs.image.files = [];
                WebChat.Attrs.image.src = [];
                WebChat.Attrs.image.count = 0;
                WebChat.Attrs.current.imageIndex = 0;
                WebChat.Doms.conversation.imageListDom.html("");
              }
            });
          }
          else {
            WebChat.Attrs.image.files = [];
            WebChat.Attrs.image.src = [];
            WebChat.Attrs.image.count = 0;
            WebChat.Attrs.current.imageIndex = 0;
            WebChat.Doms.conversation.imageListDom.html("");
          }
        },
        quickSend: function(thisDom, event) {      //快捷发送
          var Attrs = this.Attrs;
          if (Attrs.target.id !== null) {
            var e = event || window.event;
            e.stopPropagation();
            e.preventDefault();
            var textValue = thisDom.text();
            var sendParam = {
              type: "text",
              saying: textValue,
              extra: {
                senderRole: "waiter",
                receiveRole: Attrs.current.listType,
                name: "一二三",
                mobile: "12345678900",
                unreadMessageCount: 0
              }
            };
            this.setSendArgs(sendParam);
            this.sendMessage(); //发送文本消息
          }
        },
        setMsgType: function(type) {      // 设置自定义类型
          if (type === "Redirection") {
            var messageName = "RedirectionMessage"; // 消息名称。
            var objectName = "UD:Redirection"; // 消息内置名称，请按照此格式命名。
            var mesasgeTag = new RongIMLib.MessageTag(false, false); // 消息是否保存是否计数，true true 保存且计数，false false 不保存不计数。
            var propertys = ["redirectId", "content", "extra"]; // 消息类中的属性名。
            this.RongCloud.IMClient.registerMessageType(messageName, objectName, mesasgeTag, propertys);
          }
        },
        setSendArgs: function(messageContent) {      //设置发送的信息参数
          var Attrs = this.Attrs;
          var msg = null;
          switch (messageContent.type) {
            case "text":
              msg = new RongIMLib.TextMessage({
                content: messageContent.saying,
                extra: messageContent.extra
              }); // 设置发送到信息
              break;
            case "image":
              msg = new RongIMLib.ImageMessage({
                content: messageContent.imgSrc,
                imageUri: messageContent.imgUri,
                extra: messageContent.extra
              });
              break;
            case "redirection":
              msg = new this.RongCloud.IMClient.RegisterMessage.RedirectionMessage({
                redirectId: messageContent.redirectId,
                content: messageContent.content,
                extra: messageContent.extra
              });
              break;
            case "video":
              Attrs.sendArgs.mediaType = messageContent.mediaType;
              Attrs.sendArgs.invertUserIds = messageContent.invertUserIds;
              Attrs.sendArgs.extra = JSON.stringify(messageContent.extra);
              break;
          }
          Attrs.sendArgs.msg = msg;
          this.Attrs.sendArgs = Attrs.sendArgs;
        },
        sendMessage: function(callback) {
          var Attrs = WebChat.Attrs;
          var args = Attrs.sendArgs;
          this.RongCloud.IMClient.getInstance().sendMessage(args.conversationtype, Attrs.target.id, args.msg, { //发送消息
            onSuccess: function(message) {
              console.log(message);
              var receiveRole = Attrs.current.listType;
              if (!Attrs.chatList[receiveRole][Attrs.target.id]) { //列表区没有该用户的信息
                Attrs.chatList[receiveRole][Attrs.target.id] = message.content.extra; //设置存在该tip
              }

              console.log("sendMsg  ========================= " + Attrs.current.imageIndex);
              WebChat.Attrs = Attrs;
              WebChat.addSaying(message, "only"); //在会话区添加消息
              if (callback) callback();
            },
            onError: function(errorCode, message) {
              alert(JSON.stringify(errorCode));
            }
          });
        },
      /* e 消息 */

      /* s 窗口操作 */
        showWindow: function(thisDom) {
          try {
            this.Doms.temporary.selectTipDom.removeClass("tip-selected");
          }catch (e) {}
          thisDom.addClass("tip-selected");
          this.Doms.temporary.selectTipDom = thisDom;
          var type = this.Attrs.current.listType;

          if (this.Attrs.current.tipType !== type) {
            this.Doms.temporary.navSignDom.removeClass("chating-sign");
            $("[data-type='" + type + "']").find("div").addClass("chating-sign");
            this.Doms.temporary.navSignDom = $(".chating-sign");
          }
          this.Attrs.current.tipType = type;

          var targetId = thisDom.attr("data-id"); //获得点击的客户id
          if (targetId !== this.Attrs.target.id) { //若与当前聊天对象不符
            this.Attrs.mark.history = true; //设置可以获取历史记录
            this.Attrs.target.id = targetId; //修改当前聊天对象
            this.Doms.conversation.contentDom.html(""); //清空会话区所有消息
            var name = thisDom.attr("data-name"); //获得点击的客户name
            if (thisDom.attr("data-badge")) {      //有未读消息
              var count = this.Attrs.unreadCount[targetId];
              var avatar = name.slice(-1);
              if (!name) {
                name = "无名";
                avatar = "无";
              }
              if (type === "customer") {
                thisDom.find(".tip-unread").html(avatar); //更换头像标志
              }
              thisDom.attr("data-badge", ""); //是否存在未读消息设置为否
              this.loadUnreadMsg(function(amount) { //加载未读消息数
                if (count > amount) {
                  amount = count;
                }
                WebChat.loadHistoryMsg("unread", amount); //在历史消息中获取对应数量的消息
                WebChat.Attrs.unreadCount[targetId] = 0;
                localStorage.Unread = JSON.stringify(WebChat.Attrs.unreadCount[targetId]);
              });
            }
            this.Doms.conversation.customerNameDom.text(name); //改变客户名
            this.Doms.conversation.wholeDom.show(); //会话区show
            this.Doms.teleprompter.wholeDom.show(); //提词器show
          }
        },
        openWebChat: function() {
          this.Doms.minimize.wholeDom.hide();
          this.Doms.nav.wholeDom.show();
          this.Doms.list.wholeDom.show();
          this.Doms.conversation.wholeDom.show();
          this.Doms.teleprompter.wholeDom.show();
        },
        hideWindow: function() {
          this.Doms.conversation.wholeDom.hide();
        },
        minimize: function() {
          this.Doms.nav.wholeDom.hide();
          this.Doms.list.wholeDom.hide();
          this.Doms.conversation.wholeDom.hide();
          this.Doms.teleprompter.wholeDom.hide();
          this.Doms.minimize.wholeDom.show();
        },
        closeWebChat: function() {
          this.Doms.nav.wholeDom.hide();
          this.Doms.list.wholeDom.hide();
          this.Doms.conversation.wholeDom.hide();
          this.Doms.teleprompter.wholeDom.hide();
          this.Doms.conversation.contentDom.html("");
          this.Doms.minimize.wholeDom.show();
          this.Doms.conversation.inputDom.val("");
        },
      /* e 窗口操作 */

      /* s 提词器 */
        closeTeleprompter: function () {
          this.Doms.teleprompter.wholeDom.hide();
          this.Doms.conversation.wholeDom.addClass("radius-t-r-5 radius-b-r-5");
          this.Doms.conversation.headerDom.addClass("radius-t-r-5");
          this.Doms.conversation.toolsRightDom.addClass("radius-t-r-5");
          this.Doms.conversation.writeDom.addClass("radius-b-r-5");
        },
        showTeleprompter: function () {
          this.Doms.conversation.wholeDom.removeClass("radius-t-r-5 radius-b-r-5");
          this.Doms.conversation.headerDom.removeClass("radius-t-r-5");
          this.Doms.conversation.toolsRightDom.removeClass("radius-t-r-5");
          this.Doms.conversation.writeDom.removeClass("radius-b-r-5");
          this.Doms.teleprompter.wholeDom.show();
        },
        showWholeHint: function(thisDom, event) {
          var e = event || window.event;
          var itemDom = thisDom.parent();
          var contentDom = thisDom.siblings("p");
          e.stopPropagation();
          e.preventDefault();
          var mark = itemDom.hasClass("hint-default-height");
          if (mark) {
            itemDom.removeClass("hint-default-height");
            contentDom.removeClass("omit").removeClass("no-select").css("word-wrap", "break-word");
          }
          else {
            itemDom.addClass("hint-default-height");
            contentDom.css("word-wrap", "normal").addClass("no-select").addClass("omit");
          }
        },
        modifyHint: function(thisDom, event) {
          var e = event || window.event;
          e.preventDefault();
          e.stopPropagation();
          var itemDom = thisDom.parent();
          var hintDom = thisDom.siblings("p");
          var mark = hintDom.attr("contenteditable");
          var flag = itemDom.hasClass("hint-default-height");
          if (mark) {
            hintDom.removeAttr("contenteditable");
          }
          else {
            if (flag) {
              itemDom.removeClass("hint-default-height");
              hintDom.removeClass("omit").removeClass("no-select").css("word-wrap", "break-word");
            }
            hintDom.attr("contenteditable", true);
          }
        },
        deleteHint: function(thisDom, event) {
          var e = event || window.event;
          e.preventDefault();
          e.stopPropagation();
          thisDom.parent().remove();
        },
        showLinkContent: function(thisDom, event) {
          var e = event || window.event;
          e.preventDefault();
          e.stopPropagation();
          var linkId = thisDom.parent().attr("data-link-content");
          var mark = thisDom.attr("data-show");
          if (mark) {
            $("#" + linkId).css("display", "none");
            thisDom.attr("data-show", "");
          } else {
            $("#" + linkId).css("display", "block");
            thisDom.attr("data-show", "1");
          }
        },
        removeLinkContent: function(thisDom, event) {
          var e = event || window.event;
          e.preventDefault();
          e.stopPropagation();
          var linkId = thisDom.parent().attr("data-link-content");
          var reconfirm = confirm("您确认删除该栏目以及该栏目下的所有提示内容么？");
          if (reconfirm === true) {
            $("#" + linkId).remove();
            thisDom.parent().remove();
          }
        },
        addLinkHint: function(thisDom, event) {
          var e = event || window.event;
          e.preventDefault();
          e.stopPropagation();
          var linkId = thisDom.parent().attr("data-link-content");
          var str = "<li class='teleprompter-hint hint-default-height'>" +
            "<img src='' class='teleprompter-hint-operation fl' onclick='javascript: WebChat.showWholeHint($(this));'>" +
            "<img src='' class='teleprompter-hint-operation fl' onclick='javascript: WebChat.modifyHint($(this));'>" +
            "<img src='' class='teleprompter-hint-operation fl' onclick='javascript: WebChat.deleteHint($(this));'>" +
            "<p class='teleprompter-hint-message omit no-select' ondblclick='javascript: WebChat.quickSend($(this));'>请修改此处内容</p>" +
            "</li>";
          $("#" + linkId).append(str);
        },
        addTeleprompter: function(event) {
          var e = event || window.event;
          e.preventDefault();
          e.stopPropagation();
          var person = prompt("请输入新的栏目名", "请少于七个汉字");
          if (person !== null && person !== "") {
            if (person.length <= 7) {
              var index = this.Doms.teleprompter.contentDom.attr("data-count");
              var str = "<div class='webchat-teleprompter-item'>" +
                "<div class='teleprompter-item-header' data-link-content='teleprompter-" + index + "'>" +
                "<img src='' class='teleprompter-expansion-sign fl' onclick='javascript: WebChat.showLinkContent($(this));' data-show='1'>" +
                "<p class='webchat-teleprompter-title omit fl' ondblclick='javascript: WebChat.modifyTitle($(this));'>" + person + "</p>" +
                "<img src='' class='teleprompter-expansion-sign fr' onclick='javascript: WebChat.removeLinkContent($(this));'>" +
                "<img src='' class='teleprompter-expansion-sign fr' onclick='javascript: WebChat.addLinkHint($(this));'>" +
                "</div>" +
                "<ul class='teleprompter-item-content' id='teleprompter-" + index + "'></ul>" +
                "</div>";
              this.Doms.teleprompter.contentDom.append(str);
            }
            else {
              alert("请不要超过7个汉字");
            }
          }
          else {
            alert("请输入内容");
          }
        },
        modifyTitle: function(thisDom, event) {
          var e = event || window.event;
          e.preventDefault();
          e.stopPropagation();
          var content = thisDom.text();
          var person = prompt("请输入新的栏目名", content);
          if (person !== null && person !== "") {
            if (person.length <= 7) {
              thisDom.text(person);
            }
            else {
              alert("请不要超过7个汉字");
            }
          }
          else {
            alert("请输入内容");
          }
        },
      /* e 提词器 */

      /* s 转接 */
        selectWaiter: function (thisDom) {
          if (this.Doms.temporary.redirectWaiterDom) {
            this.Doms.temporary.redirectWaiterDom.removeClass("redirect-selected");
          }
          thisDom.addClass("redirect-selected");
          this.Doms.temporary.redirectWaiterDom = thisDom;
        },
        redirecting: function(thisDom, event) {
          var ev = window.event || event;
          ev.stopPropagation();
          if (this.Doms.temporary.redirectWaiterDom) {
            var waiterId = this.Doms.temporary.redirectWaiterDom.attr("data-id");
            sendParam = {
              type: "redirection",
              redirectId: waiterId,
              content: "This message is used to redirect.",
              extra: {
                senderRole: "waiter",
                receiveRole: WebChat.Attrs.current.listType,
                name: "一二三",
                mobile: "12345678900",
              }
            };

            this.setSendArgs(sendParam);
            this.sendMessage(function() { //发送文本消息
              delete WebChat.Attrs.chatList.customer[WebChat.Attrs.target.id];
              localStorage.CustomerList = JSON.stringify(WebChat.Attrs.chatList.customer);
              WebChat.Doms.temporary.redirectTipDom.parents(".webchat-tip").remove();
              WebChat.closeRedirectWindow();
            });
          }
          else {
            alert("请选择您要转接的客服");
          }
        },
        openRedirectWindow: function(thisDom, event) {
          var ev = window.event || event;
          ev.stopPropagation();
          this.Doms.temporary.redirectTipDom = thisDom;
          this.Attrs.target.id = thisDom.parents(".webchat-tip").attr("data-id");
          this.Doms.redirect.wholeDom.show();
        },
        closeRedirectWindow: function() {
          this.Doms.redirect.wholeDom.hide();
          if (WebChat.Doms.temporary.redirectWaiterDom) {
              WebChat.Doms.temporary.redirectWaiterDom.removeClass("redirect-selected");
          }
          WebChat.Doms.temporary.redirectTipDom = null;
          WebChat.Doms.temporary.redirectWaiterDom = null;
        },
      /* e 转接*/

      /* s 客户标签 */
        addListTip: function() {
          var htmlStr = "";
          var message;
          var type = arguments[0];
          var count = arguments.length;
          if (count === 1) {
            var list = this.Attrs.chatList[type];
            for (var targetId in list) {
              message = list[targetId];
              htmlStr += this.setListTipHtml(type, message, targetId);
            }
          }
          else if (count === 2) {
            message = arguments[1];
            if ($.isArray(message)) {
              var len = message.length;
              for (var i = 0; i < len; i++) {
                htmlStr += this.setListTipHtml(type, message[i]);
              }
            }
            else {
              htmlStr = this.setListTipHtml(type, message);
            }
          }
          else if (count === 3) {
              message = arguments[1];
              htmlStr = this.setListTipHtml(type, message, targetId);
          }
          this.Doms.list[type + "Dom"].append(htmlStr);   //列表区添加tip
        },
        seachTip: function () {
          var value = this.Doms.list.inputDom.val();
          var num = value * 1;
          var doms;
          if (typeof num === "number") {
            doms = $("[data-id*='" + value + "'][class!='waiter-list-item fl']");
          }
          else {
            doms = $("[data-name*='" + value + "'][class!='waiter-list-item fl']");
          }
          this.Doms.list.seachDom.html(doms);
          this.showList("seach");
        },
        removeTip: function(tipDom, event) {
          var ev = window.event || event;
          ev.stopPropagation();
          var id = tipDom.attr("data-id"); //获得点击的客户id
          tipDom.remove(); //删除该客户的tip
          delete this.Attrs.chatList[this.Attrs.current.listType][id];
          if (id == this.Attrs.target.id) {
            this.Doms.conversation.contentDom.html(""); //清空会话区所有消息
            this.Doms.conversation.writeDom.html("");
            this.Doms.conversation.imageListDom.html("");
          }
        },
      /* e 客户标签 */

      /* s 列表选择 */
        showList: function(type) {
          this.Attrs.current.listType = type;
          for (var name in this.Doms.list) {
            if (name !== "wholeDom" && name !== "inputDom") {
              if (name !== type + "Dom") {
                this.Doms.list[name].hide();
              }
              else {
                this.Doms.list[name].show();
              }
            }
          }
        },
        getConversationList: function() {
          this.RongCloud.IMClient.getInstance().getConversationList({
            onSuccess: function(list) {
              console.log(list);
              var Attrs = WebChat.Attrs;
              var len = list.length;
              var deadLine = (new Date()).getTime() - 604800000; //一星期前
              for (var i = 0; i < len; i++) {
                var extra = this.translateJson(list[i].latestMessage.content.extra);
                var senderRole = extra.senderRole;
                var targetId = list[i].targetId;
                var receivedTime = list[i].targetId;
                if (senderRole !== "customer" || (receivedTime >= deadLine && senderRole === "customer")) {
                  Attrs.chatList[senderRole][targetId] = list[i];
                }
              }
              WebChat.Attrs = Attrs;
              localStorage.chatList = JSON.stringify(Attrs.chatList);
              setTimeout(this.getConversationList, 3600000); //每隔一小时刷新一次
            },
            onError: function(error) {
              // do something...
              console.log(error);
            }
          }, null);
        },
      /* e 列表选择 */

      /* s 键盘操作 */
        inputOperate: function(event) {
          var e = event || window.event;
          e.stopPropagation();
          if (e.keyCode == 13) {
            e.preventDefault();
            if (e.ctrlKey) {
              $(this).val(function(index, text) {
                return text + "\n";
              });
            } else {
              WebChat.send();
            }
          }
        },
        keepSide: function(event) {
          var e = event || window.event;
          e.stopPropagation();
          var Doms = WebChat.Doms;
          if (e.ctrlKey) {
            e.preventDefault();
            if (e.keyCode == 37) { //lef
              Doms.webchatDom.html("");
              Doms.webchatDom.append(Doms.nav.wholeDom).append(Doms.list.wholeDom).append(Doms.conversation.wholeDom).append(Doms.minimize.wholeDom);
              Doms.webchatDom.css({
                left: 0,
                right: "none"
              });
              Doms.minimize.openSignDom.remove();
              Doms.minimize.wholeDom.children().first().before(WebChat.openSignDom);
              Doms.minimize.wholeDom.css({
                left: 0,
                right: "none"
              });
            } else if (e.keyCode == 39) { //right
              Doms.webchatDom.html("");
              Doms.webchatDom.append(Doms.conversation.wholeDom).append(Doms.list.wholeDom).append(Doms.nav.wholeDom).append(Doms.minimize.wholeDom);
              Doms.webchatDom.css({
                left: "none",
                right: 0
              });
              Doms.minimize.openSignDom.remove();
              Doms.minimize.wholeDom.children().last().after(WebChat.openSignDom);
              Doms.minimize.wholeDom.css({
                left: "none",
                right: 0
              });
            } else if (e.keyCode == 38) { //up
              Doms.webchatDom.css({
                top: 0,
                bottom: "none"
              });
              Doms.minimize.wholeDom.css({
                top: 0,
                bottom: "none"
              });
            } else if (e.keyCode == 40) { //Down
              Doms.webchatDom.css({
                top: "none",
                bottom: 0
              });
              Doms.minimize.wholeDom.css({
                top: "none",
                bottom: 0
              });
            }
          }
        },
      /* e 键盘操作 */

      /* s 从服务器获取消息 （未读 / 历史）*/
        loadUnreadMsg: function(callback) {
          var conversationType = 1; //私聊
          this.RongCloud.IMClient.getInstance().getUnreadCount(conversationType, this.Attrs.target.id, { //加载未读消息数
            onSuccess: function(amount) {
              console.log(amount);
              if (callback) callback(amount);
            },
            onError: function(error) {
              // error => 获取指定会话未读数错误码。
              console.log(error);
              alert(JSON.stringify(error));
            }
          });
        },
        loadHistoryMsg: function() {
          var conversationType = 1; //私聊,其他会话选择相应的消息类型即可。
          var timestrap = null; // 默认传 null，若从头开始获取历史消息，请赋值为 0 ,timestrap = 0;
          var count;
          var type = arguments[0];

          if (type == "unread") { //未读消息
            var amount = arguments[1];
            if (amount > 20) { //单次最多两条
              count = 20;
            }
            else if (amount <= 1) { //单次最小2条
              count = 2;
            }
            else {
              count = amount;
            }
          }
          else if (type == "history") { //历史消息
            count = 20; //默认 20条
          }

          if (this.Attrs.target.id !== null) { // 存在targetId
            this.RongCloud.IMClient.getInstance().getRemoteHistoryMessages(conversationType, this.Attrs.target.id, timestrap, count, {
              onSuccess: function(list, hasMsg) {
                if (type == "unread") { //未读
                  if (amount == 1) { //1条未读
                    WebChat.addSaying(list[1], "only"); //会话区添加消息
                  }
                  else if (amount > 20) { //超过20条未读
                    WebChat.addSaying(list, "whole"); //会话区添加消息
                    if (hasMsg) { // 还有消息
                      amount -= 20; //重设消息数
                      WebChat.loadHistoryMsg(effect, amount); //递归取消息
                    }
                  }
                  else {
                    WebChat.addSaying(list, "whole"); //会话区添加消息
                  }
                }
                else if (type == "history" && WebChat.Attrs.mark.history) { //历史消息
                  WebChat.addSaying(list, "whole"); //会话区添加消息
                  WebChat.Attrs.mark.history = hasMsg; //是否还存在消息没有加载
                }
              },
              onError: function(error) {
                console.log("GetHistoryMessages,errorcode:" + error);
              }
            });
          }
          else {
            alert("请选择聊天对象！");
          }
        },
      /* e 从服务器加载消息 （未读 / 历史）*/

      /* s 黑名单 */
        getBlackList: function() {
          this.RongCloud.IMClient.getInstance().getBlacklist({
            onSuccess: function(blackList) {
                //数据库查询
            },
            onError: function(error) {
              console.log(error);
              alert("获取黑名单失败");
              // 获取黑名单失败
            }
          });
        },
        addToBlackList: function(thisDom) {
          var result = confirm("请确认将该用户加入黑名单");
          if (result) {
            var tipDom = thisDom.parents(".webchat-tip");
            var id = tipDom.attr("data-id");
            var name = tipDom.attr("data-name");
            this.RongCloud.IMClient.getInstance().addToBlacklist(id, {
              onSuccess: function() {
                WebChat.removeTip(tipDom);
                WebChat.Attrs.chatList.black[id] = name;
                localStorage.BlackList = JSON.stringify(WebChat.Attrs.chatList.black);
                WebChat.addListTip("blcak", name, id);
              },
              onError: function(error) {
                // 加入黑名单失败。
                console.log(error);
                alert("加入黑名单失败");
              }
            });
          }
        },
        removeFromBlackList: function(thisDom) {
          var result = confirm("您确定将该客户移除黑名单？");
          if (result) {
            var tipDom = thisDom.parents(".webchat-tip");
            var id = tipDom.attr("data-id");
            this.RongCloud.IMClient.getInstance().removeFromBlacklist(userId, {
              onSuccess: function() {
                WebChat.removeTip(tipDom);
                localStorage.BlackList = JSON.stringify(WebChat.Attrs.chatList.black);
              },
              onError: function(error) {
                alert("移除失败");
              }
            });
          }
        },
      /* e 黑名单 */

      /* s 工具方法 */
        formatDate: function(timestamp, type) {
          var time = new Date(timestamp);
          var y = time.getFullYear();
          var m = time.getMonth() + 1;
          var d = time.getDate();
          var h = time.getHours();
          var mm = time.getMinutes();

          function add0(m) {
            return m < 10 ? '0' + m : m;
          }
          // var intactTime = y + '-' + add0(m) + '-' + add0(d) + ' ' + add0(h) + ':' + add0(mm);
          var resultTime;
          if (type == "tip") {
            resultTime = add0(h) + ':' + add0(mm);
          } else if (type == "remind") {
            resultTime = add0(m) + '-' + add0(d) + ' ' + add0(h) + ':' + add0(mm);
          }
          return resultTime;
        },
        addSaying: function(message, type) {
          var htmlStr = "";
          //设置添加的htmlString
          if ($.isArray(message)) { //判断是不是多个消息组成的数组
            var len = message.length;
            for (var i = 0; i < len; i++) {
              htmlStr += this.setSayingHtml(message[i]); //设置对应的html
            }
          }
          else { //单读发送或读取的消息
            htmlStr = this.setSayingHtml(message); //设置对应的html
          }

          //在对应位置插入htmlString
          var contentDom = this.Doms.conversation.contentDom;
          if (!!contentDom.html()) {
            if (type == "only") { //单条消息
              contentDom.children().last().after(htmlStr); //在最后面添加
            } else if (type == "whole") { //多条消息
              contentDom.children().first().after(htmlStr); //最前面添加
            }
          }
          else {
            contentDom.html(htmlStr);
          }
          this.Doms.conversation.contentDom = contentDom;
          WebChat.scrollToSide(this.Doms.conversation.contentDom, this.Doms.conversation.windowDom, "bottom"); //保持最底部
        },
        setSayingHtml: function(message) {
          var saying = ""; //消息内容
          var htmlStr = ""; //模板
          var mark = message.senderUserId === this.Attrs.target.id;
          switch (message.objectName) {
            case "RC:TxtMsg":
              if (mark) { //other
                saying = "<span class='conversation-saying arrow-left saying-background-left'>" + message.content.content + "</span>";
              }
              else { //me
                saying = "<span class='conversation-saying arrow-right saying-background-right'>" + message.content.content + "</span>";
              }
              break;
            case "RC:ImgMsg":
              if (mark) { //other
                saying = "<div class='conversation-image-box fl'>" +
                  "<img src='data:image/jpeg;base64," + message.content.content + "' data-url='" + message.content.imageUri + "' class='conversation-image' ondblclick='javascript: WebChat.showImage($(this));'>" +
                  "</div>";
              }
              else { //me
                saying = "<div class='conversation-image-box fr'>" +
                  "<img src='" + this.Attrs.image.src[this.Attrs.current.imageIndex] + "' class='conversation-image'>" +
                  "</div>";
              }
              break;
          }
          if (mark) { // 发送者id == 接受者ID  即此条消息是对方发送
            htmlStr = "<li class='conversation-message message-left'>" +
              "<img src='' class='conversation-author-avatar fl'>" +
              saying +
              "</li>";
          }
          else { //我方发送
            htmlStr = "<li class='conversation-message message-right'>" +
              "<img src='' class='conversation-author-avatar fr'>" +
              saying +
              "</li>";
          }
          return htmlStr;
        },
        setListTipHtml: function() {
          var id, name, avatar, extra, unreadCount, className, status;
          var htmlStr = "";
          var type = arguments[0];
          var message = arguments[1];
          if (message.latestMessage) {
            id = message.senderUserId;
            extra = this.translateJson(message.latestMessage.content.extra);
            name = !!extra.name ? extra.name : "无名";
            unreadCount = this.Attrs.unreadCount[id];
          }
          else if (message.content) {
            id = message.senderUserId;
            extra = this.translateJson(message.content.extra);
            name = !!extra.name ? extra.name : "无名";
            unreadCount = this.Attrs.unreadCount[id];

          }
          else if (arguments.length === 3) {
            id = arguments[2];
            name = !!message ? message : "无名";
            unreadCount = this.Attrs.unreadCount[id];
          }

          if (!unreadCount) {
            unreadCount = "";
          }

          if (name === "无名") {
            avatar = "无";
          }
          else {
            avatar = name.slice(-1);
          }

          if (!!unreadCount) {
            className = "status-unread";
            status = unreadCount;
          }
          else {
            className = "status-chated";
            status = avatar;
          }

          if (type == "customer") {
            htmlStr = "<li class='webchat-tip customer-tip' data-id='" + id + "' data-name='" + name + "' data-badge='' onclick='javascript: WebChat.showWindow($(this));'>" +
              "<div class='tip-unread " + className + " fl'>" + status + "</div>" +
              "<div class='tip-name omit fl'>" + name + "</div>" +
              "<div class='tip-mobile fl'>" + id + "</div>" +
              "<i class='iconfont icon-zhuanyi tip-btn fl' onclick='javascript: WebChat.openRedirectWindow($(this));'></i>" +
              "<i class='iconfont icon-lahei tip-btn fl' onclick='javascript: WebChat.addToBlackList($(this));'></i>" +
              "</li>";
          }
          else if (type == "waiter") {
            htmlStr = "<li class='webchat-tip waiter-tip' data-id='" + id + "' data-name='" + name + "' data-badge='1' onclick='javascript: WebChat.showWindow($(this));'>" +
              "<div class='tip-avatar " + className + " fl'>" + avatar + "</div>" +
              "<div class='tip-name fl'>" + name + "</div>" +
              "<div class='tip-unread fl'>" + unreadCount + "</div>" +
              "</li>";
          }
          else if (type == "black") {
            htmlStr = "<li class='webchat-tip black-tip' data-id='" + id + "' data-name='" + name + "' onclick='javascript: WebChat.removeFromBlackList($(this));'>" +
              "<div class='tip-avatar status-chated fl'>" + avatar + "</div>" +
              "<div class='tip-name fl'>" + name + "</div>" +
              "<div class='tip-mobile fl'>" + id +  "</div>" +
              "</li>";
          }
          return htmlStr;
        },
        addDropImage: function(file) {
          if (file.type === "image/jpeg") {
            var src = URL.createObjectURL(file);
            var htmlStr = "<li data-index='" + (++WebChat.Attrs.image.count) + "' class='webchat-image-wrap fl relative'>" +
              "<img src='" + src + "' class='webchat-image-input fl' ondblclick='javascript: WebChat.showImage($(this));'>" +
              "<span class='absolute image-badge' onclick='javascript: WebChat.abandonImg($(this));'>x</span>" +
              "</li>";
            WebChat.Doms.conversation.imageListDom.append(htmlStr);
            WebChat.Doms.conversation.imageListDom.width(function(index, widthSize) {
              return (widthSize + 45) + "px";
            });
            var imageNavDom = WebChat.Doms.conversation.imageListDom.parent();
            WebChat.scrollToSide(WebChat.Doms.conversation.imageListDom, imageNavDom, "right");
            this.Attrs.image.files.push(file);
            this.Attrs.image.src.push(src);
          }
          else {
            console.log("此" + files[i].name + "不是图片文件！");
          }
        },
        setThumbnail: function(callback) {
          var src = this.Attrs.image.src[this.Attrs.current.imageIndex];
          var file = this.Attrs.image.files[this.Attrs.current.imageIndex];
          this.Doms.sundry.backImageDom.attr("src", src).load(function() {
            var width = $(this).width();
            var height = $(this).height();
            WebChat.Doms.sundry.canvasDom.attr({
              "width": width,
              "height": height
            });
            var ctx = WebChat.Doms.sundry.canvasDom[0].getContext("2d");
            ctx.clearRect(0, 0, width, height);
            ctx.drawImage($(this)[0], 0, 0, width, height);
            var scale;
            if (file.size > 92160) {
              scale = 92160 * 0.92 / file.size;
            }
            else {
              scale = 0.92;
            }
            var url = WebChat.Doms.sundry.canvasDom[0].toDataURL('image/jpeg', scale).substr(23);
            if (callback) callback(url);
          });
        },
        translateJson: function (jsonStr) {
          var json = null;
          if (!!jsonStr) {
            if (typeof jsonStr === "string") {
              json = JSON.parse(jsonStr);
            }
            else {
              json = jsonStr;
            }
          }
          return json;
        },
        scrollToSide: function (itemDom, wrapDom, side) {
          if (side === "bottom") {
            if (itemDom.height() > wrapDom.height()) {
              wrapDom.scrollTop(itemDom.height()); //永远显示最底部
            }
          }
          else if (side === "right") {
            if (itemDom.width() > wrapDom.width()) {
              wrapDom.scrollLeft(itemDom.width()); //永远显示最底部
            }
          }
        },
        setUnreadStatus: function (targetId) {
          var tipDom = $("[data-id='" + targetId + "']"); //获取列表中对应用户的tip
          var badgeMark = tipDom.hasClass("status-unread"); //是否有未读消息
          if (badgeMark) { //有未读消息
            WebChat.Attrs.unreadCount[targetId] += 1; //修改未读信息数
            tipDom.find(".tip-unread").text(function(index, text) { //修改显示的消息数
              return text * 1 + 1;
            });
          }
          else { //无
            tipDom.removeClass("status-chated");
            tipDom.addClass("status-unread");
            tipDom.find(".tip-unread").text(1);
            tipDom.attr("data-badge", "true"); //修改为显示了未读消息
            WebChat.Attrs.unreadCount[targetId] = 1; //添加一个含有未读消息的客户
          }

          localStorage.Unread = JSON.stringify(WebChat.Attrs.unreadCount);
        },
      /* e 工具方法 */

      /* s 效果 */
        showImage: function(thisDom, event) {
          var e = event || window.event; //获取 e
          var src = thisDom.attr("data-url") ? thisDom.attr("data-url") : thisDom.attr("src"); //获取 src
          var exhibitBoxDom = this.Doms.modal.exhibitDom.parent(); //获取
          e.stopPropagation(); //停止扩散
          this.Doms.modal.wholeDom.css("z-index", '99'); //模态框浮现
          this.Doms.modal.exhibitDom.attr("src", src); //输入地址
          this.Doms.modal.exhibitDom.load(function () {
            exhibitBoxDom.css({    //绝对居中
              "margin-left": exhibitBoxDom.width() * -0.5 + "px",
            });
          });
        },
        hiddenModal: function(event) {
          var e = event || window.event; //获取 e
          e.stopPropagation(); //停止扩散
          WebChat.Doms.modal.wholeDom.css("z-index", '-99'); //模态框隐藏
        },
        movement: function(event) {
          var e = event || window.event;
          e.stopPropagation();
          var mark = true;
          var thisDom = $(this);
          var offset = thisDom.offset();
          var initX = e.pageX;
          var initY = e.pageY;
          $(document).on("mousemove", moving);
          $(document).one("mouseup", function(event) {
            var e = event || window.event;
            e.stopPropagation();
            $(document).unbind("mousemove", moving);
            mark = false;
          });

          function moving(event) {
            if (mark) {
              var e = event || window.event;
              e.stopPropagation();
              var finalX = e.pageX;
              var finalY = e.pageY;
              var left = offset.left + finalX - initX;
              var top = offset.top + finalY - initY;
              thisDom.css({
                left: left + "px",
                top: top + "px"
              });
            }
          }
        },
        banCover: function(event) {
          var e = event || window.event;
          e.preventDefault();
        },
        dropImg: function(event) {
          var e = event || window.event;
          e.stopPropagation();
          e.preventDefault();
          var files = e.dataTransfer.files;
          var len = files.length;
          for (var i = 0; i < len; i++) {
            WebChat.addDropImage(files[i]);
          }
        },
        abandonImg: function(thisDom) {
          var index = thisDom.parent().attr("data-index");
          this.Attrs.image.files[index] = null;
          thisDom.parent().remove();
          this.Doms.conversation.imageListDom.width(function(index, widthSize) {
            return (widthSize - 45) + "px";
          });
        },
      /* e 效果 */
    };
    WebChat.main();
  </script>
</body>
</html>
